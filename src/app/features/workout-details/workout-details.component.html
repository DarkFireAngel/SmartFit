<!-- Top App Bar -->
<div class="sticky top-0 z-40 w-full glass-panel border-b border-black/5 dark:border-white/5">
    <div class="flex items-center p-4 justify-between h-16">
        <button (click)="finishWorkout()"
            class="flex size-12 shrink-0 items-center justify-center rounded-full hover:bg-black/5 dark:hover:bg-white/5 transition-colors">
            <span class="material-symbols-outlined">arrow_back</span>
        </button>
        <div class="flex flex-col items-center">
            <h2 class="text-lg font-bold leading-tight tracking-tight">{{ workoutName }}</h2>
            <span class="text-xs font-medium text-gray-500 dark:text-gray-400">{{ elapsedTime }} elapsed</span>
        </div>
        <button (click)="finishWorkout()"
            class="flex h-10 items-center justify-center px-4 rounded-full bg-primary/10 hover:bg-primary/20 text-primary font-bold text-sm transition-colors">
            Finish
        </button>
    </div>
</div>

<!-- Main Content -->
<main class="flex flex-col gap-6 p-4 max-w-2xl mx-auto w-full pb-28">
    <!-- Global Workout Timer / Stats Summary -->
    <div class="grid grid-cols-3 gap-3">
        <div class="flex flex-col items-center justify-center p-3 rounded-xl bg-card-light dark:bg-card-dark shadow-sm">
            <span class="material-symbols-outlined text-primary mb-1 text-[20px]">fitness_center</span>
            <p class="text-xs text-gray-500 dark:text-gray-400">Volume</p>
            <p class="text-sm font-bold">{{ totalVolume }} kg</p>
        </div>
        <div
            class="flex flex-col items-center justify-center p-3 rounded-xl bg-card-light dark:bg-card-dark shadow-sm ring-1 ring-primary/20">
            <span class="material-symbols-outlined text-primary mb-1 text-[20px]">timer</span>
            <p class="text-xs text-gray-500 dark:text-gray-400">Duration</p>
            <p class="text-sm font-bold">{{ duration }}m</p>
        </div>
        <div class="flex flex-col items-center justify-center p-3 rounded-xl bg-card-light dark:bg-card-dark shadow-sm">
            <span class="material-symbols-outlined text-primary mb-1 text-[20px]">local_fire_department</span>
            <p class="text-xs text-gray-500 dark:text-gray-400">Calories</p>
            <p class="text-sm font-bold">{{ caloriesBurned }}</p>
        </div>
    </div>

    <!-- Exercise Cards -->
    <div *ngFor="let exercise of exercises; let exerciseIndex = index"
        class="flex flex-col rounded-2xl bg-card-light dark:bg-card-dark shadow-sm overflow-hidden"
        [ngClass]="exercise.isActive ? 'ring-2 ring-primary/20' : ''">
        <!-- Header -->
        <div class="flex flex-col px-4 pt-5 pb-2">
            <div class="flex justify-between items-start mb-1">
                <h3 class="text-xl font-bold leading-tight">{{ exercise.name }}</h3>
                <button class="text-gray-400 hover:text-primary transition-colors">
                    <span class="material-symbols-outlined">more_horiz</span>
                </button>
            </div>
            <p class="text-primary text-sm font-medium">Target: {{ exercise.targetSets }} sets x {{
                exercise.targetRepsMin }}-{{ exercise.targetRepsMax }} reps</p>
        </div>

        <!-- Sets Header -->
        <div
            class="grid grid-cols-[32px_1fr_1fr_1fr_40px] gap-3 px-4 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider text-center">
            <div class="text-left">Set</div>
            <div class="text-left">Prev</div>
            <div>kg</div>
            <div>Reps</div>
            <div></div>
        </div>

        <!-- Set Rows -->
        <div class="flex flex-col gap-2 px-4 pb-4">
            <div *ngFor="let set of exercise.sets; let setIndex = index"
                class="grid grid-cols-[32px_1fr_1fr_1fr_40px] gap-3 items-center group"
                [ngClass]="setIndex === exercise.sets.length - 1 && exercise.isActive ? 'opacity-100' : (set.completed ? 'opacity-60' : 'opacity-80')">
                <!-- Set Number -->
                <div class="flex items-center justify-center size-8 rounded-full text-sm font-bold"
                    [ngClass]="set.completed ? 'bg-primary text-gray-900' : (setIndex === 1 && exercise.isActive ? 'bg-primary text-gray-900 shadow-[0_0_10px_rgba(19,236,91,0.4)]' : 'bg-gray-100 dark:bg-white/5 text-gray-500 dark:text-gray-400')">
                    {{ set.completed ? 'âœ“' : set.setNumber }}
                </div>

                <!-- Previous -->
                <div class="text-xs text-gray-400 text-left">
                    <span *ngIf="set.previousWeight && set.previousReps">{{ set.previousWeight }}kg x {{
                        set.previousReps }}</span>
                    <span *ngIf="!set.previousWeight || !set.previousReps">-</span>
                </div>

                <!-- Weight Input -->
                <input type="number" [(ngModel)]="set.weight" [disabled]="set.completed"
                    [placeholder]="set.previousWeight?.toString() || '-'"
                    class="h-10 w-full rounded-lg border-transparent focus:border-primary focus:ring-0 text-center font-bold text-gray-900 dark:text-white dark:placeholder-gray-600 transition-all"
                    [ngClass]="setIndex === 1 && exercise.isActive ? 'h-12 text-xl bg-gray-100 dark:bg-input-dark border-2 border-primary/50' : 'bg-gray-50 dark:bg-input-dark'">

                <!-- Reps Input -->
                <input type="number" [(ngModel)]="set.reps" [disabled]="set.completed" placeholder="-"
                    class="h-10 w-full rounded-lg border-transparent focus:border-primary focus:ring-0 text-center font-bold text-gray-900 dark:text-white dark:placeholder-gray-600 transition-all"
                    [ngClass]="setIndex === 1 && exercise.isActive ? 'h-12 text-xl bg-gray-100 dark:bg-input-dark' : 'bg-gray-50 dark:bg-input-dark'">

                <!-- Complete Button -->
                <button (click)="completeSet(exerciseIndex, setIndex)"
                    [disabled]="!set.weight || !set.reps || set.completed"
                    class="flex items-center justify-center rounded-lg transition-all"
                    [ngClass]="set.completed ? 'size-10 bg-primary text-black shadow-[0_0_15px_rgba(19,236,91,0.3)]' : (setIndex === 1 && exercise.isActive ? 'size-12 bg-gray-200 dark:bg-white/10 text-gray-400 dark:text-gray-500 hover:bg-primary hover:text-black' : 'size-10 bg-gray-200 dark:bg-white/5 text-gray-400 dark:text-gray-600 cursor-not-allowed')">
                    <span class="material-symbols-outlined">check</span>
                </button>
            </div>
        </div>

        <!-- Card Footer -->
        <div class="p-2 bg-gray-50 dark:bg-white/5 border-t border-gray-100 dark:border-white/5 flex justify-center">
            <button (click)="addSet(exerciseIndex)"
                class="w-full py-2 flex items-center justify-center gap-2 text-sm font-semibold text-gray-600 dark:text-gray-300 hover:text-primary transition-colors">
                <span class="material-symbols-outlined text-[18px]">add</span>
                Add Set
            </button>
        </div>
    </div>

    <!-- Add Exercise Button -->
    <button (click)="addExercise()"
        class="flex w-full items-center justify-center gap-2 rounded-xl border border-dashed border-gray-300 dark:border-gray-600 py-4 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-white/5 hover:border-primary hover:text-primary transition-all">
        <span class="material-symbols-outlined">add_circle</span>
        <span class="font-bold">Add Exercise</span>
    </button>
</main>

<!-- Sticky Rest Timer Widget -->
<div *ngIf="restTimerActive" class="fixed bottom-6 left-4 right-4 z-50">
    <div
        class="mx-auto max-w-2xl rounded-2xl bg-[#1c3024] dark:bg-[#0f1d14] border border-primary/20 shadow-[0_8px_32px_rgba(0,0,0,0.5)] p-1 pr-2 pl-4 flex items-center justify-between overflow-hidden relative">
        <!-- Progress Bar Background -->
        <div class="absolute bottom-0 left-0 h-1 bg-primary/20 w-full">
            <div class="h-full bg-primary rounded-r-full shadow-[0_0_10px_#13ec5b]" [style.width.%]="restProgress">
            </div>
        </div>

        <div class="flex items-center gap-3 py-3">
            <div class="flex flex-col">
                <p class="text-[10px] uppercase tracking-wider text-primary font-bold">Resting</p>
                <p class="text-2xl font-bold text-white font-mono leading-none">{{ restTimeElapsed }}</p>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <button (click)="addRestTime()"
                class="h-10 px-3 rounded-lg bg-white/5 hover:bg-white/10 text-white text-sm font-medium transition-colors border border-white/10">
                +30s
            </button>
            <button (click)="skipRest()"
                class="h-10 px-4 rounded-lg bg-primary hover:bg-[#0fd64f] text-black text-sm font-bold transition-colors flex items-center gap-1 shadow-lg shadow-primary/20">
                Skip
                <span class="material-symbols-outlined text-[18px]">skip_next</span>
            </button>
        </div>
    </div>
</div>